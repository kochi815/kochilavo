<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            text-align: center;
            background-color: #fdf6e3; /* é€šå¸¸èƒŒæ™¯ */
            margin: 0;
            padding: 15px;
            transition: background-color 0.3s ease-out; /* èƒŒæ™¯è‰²å¤‰åŒ–ã‚’å°‘ã—ã‚†ã£ãã‚Šã« */
            position: relative; /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºã®ä½ç½®åŸºæº–ç”¨ */
            min-height: 100vh;
            box-sizing: border-box;
        }
        /* ãƒœã‚¹æˆ¦ç”¨èƒŒæ™¯ã‚¯ãƒ©ã‚¹ */
        body.boss-battle-bg {
            background-color: #ffebee; /* è–„ã„èµ¤ç´«ç³» */
        }

        h1 { font-size: 1.8em; color: #d35400; margin-bottom: 10px; }

        #battleScreen { display: none; flex-direction: column; align-items: center; gap: 10px; }
        .character-area { border: 2px solid #eee; border-radius: 10px; padding: 10px; margin: 5px 0; width: 90%; max-width: 400px; background-color: rgba(255, 255, 255, 0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; /* æ’ƒç ´æ¼”å‡ºç”¨ */ }
        #enemyArea { border-color: #e74c3c; }
        #playerArea { border-color: #3498db; }
        .character-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; }
        .character-name { font-size: 1.1em; } .character-hp-text { font-size: 1em; }
        .hp-bar-container { height: 15px; background-color: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
        .hp-bar { height: 100%; width: 100%; border-radius: 6px; transition: width 0.3s ease-in-out; }
        #enemyArea .hp-bar { background-color: #f44336; }
        #playerArea .hp-bar { background-color: #4caf50; }
        .character-display {
            font-size: 3em; margin: 5px 0;
            transition: transform 0.1s ease-in-out, opacity 0.3s ease-out; /* æ’ƒç ´ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
            opacity: 1; /* é€šå¸¸ã¯è¡¨ç¤º */
        }
        /* æ•µæ’ƒç ´ç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ */
        .character-display.defeated {
            opacity: 0;
            transform: scale(0.5) rotate(30deg);
        }

        #question { font-size: 2.2em; margin: 15px 0; color: #2c3e50; font-weight: 700; min-height: 1.3em; }
        #answerChoices { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; margin-bottom: 10px; }
        .choice-btn { font-family: 'M PLUS Rounded 1c', sans-serif; font-size: 1.3em; padding: 10px 18px; border-radius: 8px; border: 2px solid #f39c12; background-color: #fff; color: #333; cursor: pointer; min-width: 70px; transition: background-color 0.2s, transform 0.1s; }
        .choice-btn:hover:not(:disabled) { background-color: #fef9e7; }
        .choice-btn:active:not(:disabled) { transform: scale(0.96); }
        .choice-btn:disabled { background-color: #eee; border-color: #ccc; color: #aaa; cursor: not-allowed; }
        #battleLog { font-size: 1.1em; min-height: 1.5em; margin: 10px 0; color: #c0392b; font-weight: bold; }
        #startBtn { font-family: 'M PLUS Rounded 1c', sans-serif; font-size: 1.1em; padding: 10px 30px; margin: 15px 0 5px 0; border-radius: 20px; border: none; background-color: #e67e22; color: white; font-weight: bold; cursor: pointer; min-width: 160px; transition: background-color 0.2s, transform 0.1s; }
        #startBtn:hover { background-color: #d35400; }
        #startBtn:active { transform: scale(0.97); }

        /* --- æ™‚é–“è©•ä¾¡è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #feedbackDisplay {
            position: absolute; /* ç”»é¢ä¸­å¤®ã«å›ºå®š */
            top: 45%; /* ä¸Šä¸‹ä¸­å¤®ã‚„ã‚„ä¸Š */
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8); /* ä¸­å¤®æƒãˆ & åˆæœŸã¯å°‘ã—å°ã•ã„ */
            font-size: 3em;
            font-weight: bold;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 10px 25px;
            border-radius: 15px;
            opacity: 0; /* åˆæœŸã¯é€æ˜ */
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’é€é */
            z-index: 10; /* æœ€å‰é¢ã« */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        #feedbackDisplay.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1); /* è¡¨ç¤ºæ™‚ã«å…ƒã®ã‚µã‚¤ã‚ºã« */
        }
        /* è©•ä¾¡åˆ¥ã‚«ãƒ©ãƒ¼ */
        #feedbackDisplay.critical { color: #ffeb3b; } /* é»„è‰² */
        #feedbackDisplay.perfect { color: #81d4fa; } /* æ°´è‰² */
        #feedbackDisplay.great { color: #a5d6a7; } /* ç·‘ */
        #feedbackDisplay.good { color: #fff; } /* ç™½ */
        #feedbackDisplay.slow { color: #ef9a9a; } /* èµ¤ */
        #feedbackDisplay.wrong { color: #f44336; background-color: rgba(255, 255, 255, 0.8); text-shadow: none;} /* èµ¤æ–‡å­—ãƒ»ç™½èƒŒæ™¯ */


        /* --- ãã®ä»–ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ --- */
        @keyframes shake { /* å¤‰æ›´ãªã— */ 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 50% { transform: translateX(3px); } 75% { transform: translateX(-3px); } }
        .shake-animation { animation: shake 0.2s ease-in-out; }
        /* èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ç”¨ */
        body.feedback-flash { background-color: #fff3e0; } /* ä¸€ç¬æ˜ã‚‹ã„ã‚ªãƒ¬ãƒ³ã‚¸ã« */

        @media (max-width: 600px) {
             h1 { font-size: 1.6em; }
             .character-display { font-size: 2.5em; }
             #question { font-size: 1.8em; }
             .choice-btn { font-size: 1.1em; padding: 8px 15px; min-width: 60px; }
             #startBtn { font-size: 1em; padding: 10px 25px; min-width: 140px; }
             #battleLog { font-size: 1em; }
             #feedbackDisplay { font-size: 2.5em; padding: 8px 20px;}
         }

    </style>
</head>
<body>
    <h1>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>

    <div id="modeSelectScreen">
        <h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­ï¼</h2>
        <button id="grade1ModeBtn" class="mode-btn">ğŸ’ ã—ã‚‡ã†ãŒãï¼‘ã­ã‚“ã›ã„</button>
        <button id="grade4ModeBtn" class="mode-btn">ğŸ“š ã—ã‚‡ã†ãŒãï¼”ã­ã‚“ã›ã„</button>
    </div>

    <div id="battleScreen">
        <div id="enemyArea" class="character-area">
             <div class="character-info"> <span class="character-name" id="enemyName"></span> <span class="character-hp-text">HP: <span id="enemyHPText"></span></span> </div>
             <div class="hp-bar-container"> <div class="hp-bar" id="enemyHPBar"></div> </div>
             <div class="character-display" id="enemyCharacter"></div>
        </div>
        <div id="questionArea">
            <div id="question"></div> <div id="answerChoices"></div>
        </div>
        <div id="playerArea" class="character-area">
             <div class="character-display" id="playerCharacter">ğŸ˜º</div>
             <div class="hp-bar-container"> <div class="hp-bar" id="playerHPBar"></div> </div>
             <div class="character-info"> <span class="character-name">ã«ã‚ƒã‚“ãŸã‚ã†</span> <span class="character-hp-text">HP: <span id="playerHPText"></span></span> </div>
        </div>
        <div id="infoArea">
            <div id="battleLog"></div> <button id="startBtn"></button>
        </div>
    </div>

    <div id="feedbackDisplay"></div>

  <script>
    const totalQuestionsPerStage = 10;
    let currentStage = 1;
    let gameMode = '';
    let playerMaxHP = 15;
    let playerHP = playerMaxHP;
    let currentEnemy = {};
    let enemyMaxHP = 10;
    let enemyHP = enemyMaxHP;
    let problems = [];
    let currentProblemIndex = 0;
    let questionStartTime;
    let battleInProgress = false;
    let comboCount = 0;

    // DOMè¦ç´ å–å¾—
    const modeSelectScreen = document.getElementById("modeSelectScreen");
    const grade1ModeBtn = document.getElementById("grade1ModeBtn");
    const grade4ModeBtn = document.getElementById("grade4ModeBtn");
    const battleScreen = document.getElementById("battleScreen");
    const startBtn = document.getElementById("startBtn");
    const questionDiv = document.getElementById("question");
    const answerChoicesDiv = document.getElementById("answerChoices");
    const battleLog = document.getElementById("battleLog");
    const enemyArea = document.getElementById("enemyArea");
    const enemyName = document.getElementById("enemyName");
    const enemyHPText = document.getElementById("enemyHPText");
    const enemyHPBar = document.getElementById("enemyHPBar");
    const enemyCharacter = document.getElementById("enemyCharacter");
    const playerArea = document.getElementById("playerArea");
    const playerHPText = document.getElementById("playerHPText");
    const playerHPBar = document.getElementById("playerHPBar");
    const playerCharacter = document.getElementById("playerCharacter");
    const feedbackDisplay = document.getElementById("feedbackDisplay"); // â˜…è¿½åŠ : æ™‚é–“è©•ä¾¡è¡¨ç¤ºç”¨

    const enemies = { /* ... æ•µãƒ‡ãƒ¼ã‚¿å®šç¾©ã¯çœç•¥ (å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ... */ 1: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 10, type: "normal" }, 2: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 13, type: "normal" }, 3: { name: "ã‚³ã‚¦ãƒ¢ãƒª", emoji: "ğŸ¦‡", hp: 16, type: "normal" }, 4: { name: "ã‚³ã‚¦ãƒ¢ãƒª", emoji: "ğŸ¦‡", hp: 20, type: "normal" }, 5: { name: "ãƒœã‚¹ ã‚´ãƒ–ãƒªãƒ³", emoji: "ğŸ‘º", hp: 30, type: "boss" }, 6: { name: "ã‚´ãƒ¼ã‚¹ãƒˆ", emoji: "ğŸ‘»", hp: 25, type: "normal" }, 7: { name: "ã‚´ãƒ¼ã‚¹ãƒˆ", emoji: "ğŸ‘»", hp: 30, type: "normal" }, 8: { name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", emoji: "ğŸ’€", hp: 35, type: "normal" }, 9: { name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", emoji: "ğŸ’€", hp: 40, type: "normal" }, 10: { name: "ãƒœã‚¹ ã‚µã‚¤ã‚¯ãƒ­ãƒ—ã‚¹", emoji: "ğŸ‘ï¸", hp: 55, type: "boss" }, 11: { name: "ã‚¾ãƒ³ãƒ“", emoji: "ğŸ§Ÿ", hp: 45, type: "normal" }, 12: { name: "ã‚¾ãƒ³ãƒ“", emoji: "ğŸ§Ÿ", hp: 50, type: "normal" }, 13: { name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹", emoji: "ğŸ‚", hp: 58, type: "normal" }, 14: { name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹", emoji: "ğŸ‚", hp: 65, type: "normal" }, 15: { name: "ãƒœã‚¹ ãƒ‰ãƒ©ã‚´ãƒ³", emoji: "ğŸ‰", hp: 85, type: "boss" } };
    const maxStage = Object.keys(enemies).length;

    // å•é¡Œç”Ÿæˆé–¢æ•° (å¤‰æ›´ãªã—)
    function generateProblems(stage, mode) { /* ... çœç•¥ (å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ... */ const generatedProblems = []; const count = totalQuestionsPerStage; let num1, num2, answer, questionText, type; for (let i = 0; i < count; i++) { if (mode === 'grade1') { if (stage <= 5) { type = '+'; do { num1 = Math.floor(Math.random() * 10); num2 = Math.floor(Math.random() * (10 - num1)); } while (num1 === 0 && num2 === 0); answer = num1 + num2; } else if (stage <= 10) { type = '+'; num1 = Math.floor(Math.random() * 10) + 1; num2 = Math.floor(Math.random() * 10) + 1; answer = num1 + num2; } else { type = '-'; num1 = Math.floor(Math.random() * 10) + 1; num2 = Math.floor(Math.random() * num1) + 1; answer = num1 - num2; } } else { if (stage <= 4) { type = '+'; num1 = Math.floor(Math.random() * 9) + 1; num2 = Math.floor(Math.random() * 9) + 1; answer = num1 + num2; } else if (stage <= 8) { type = '-'; num1 = Math.floor(Math.random() * 18) + 1; num2 = Math.floor(Math.random() * num1) + 1; answer = num1 - num2; } else if (stage <= 12) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; answer = num1 * num2; } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; answer = Math.floor(Math.random() * 8) + 2; num1 = num2 * answer; } } questionText = `${num1} ${type} ${num2}`; generatedProblems.push({ q: questionText, a: answer }); } for (let i = generatedProblems.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [generatedProblems[i], generatedProblems[j]] = [generatedProblems[j], generatedProblems[i]]; } return generatedProblems; }
    // é¸æŠè‚¢ç”Ÿæˆé–¢æ•° (å¤‰æ›´ãªã—)
    function generateChoices(correct) { /* ... çœç•¥ (å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ... */ const choices = new Set(); choices.add(correct); let attempts = 0; while (choices.size < 6 && attempts < 50) { const delta = Math.floor(Math.random() * 10) - 5 + (Math.random() < 0.5 ? 10 : -10); const choice = correct + delta; if (choice !== correct && choice >= 0 && !choices.has(choice)) { choices.add(choice); } attempts++; } while (choices.size < 6) { choices.add(Math.max(0, correct + choices.size + Math.floor(Math.random()*3))); } const choiceArray = Array.from(choices); choiceArray.sort(() => Math.random() - 0.5); return choiceArray; }
    // HPãƒãƒ¼æ›´æ–°é–¢æ•° (å¤‰æ›´ãªã—)
    function updateHPBar(elementId, currentHP, maxHP) { /* ... çœç•¥ (å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ... */ const bar = document.getElementById(elementId); const percentage = Math.max(0, (currentHP / maxHP) * 100); bar.style.width = `${percentage}%`; }
    // ã‚­ãƒ£ãƒ©æºã‚Œé–¢æ•° (å¤‰æ›´ãªã—)
    function shakeCharacter(elementId) { /* ... çœç•¥ (å‰ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) ... */ const characterElement = document.getElementById(elementId); characterElement.classList.add('shake-animation'); setTimeout(() => { characterElement.classList.remove('shake-animation'); }, 200); }

    // --- æ™‚é–“è©•ä¾¡è¡¨ç¤ºé–¢æ•° ---
    function showFeedback(text, type) {
        feedbackDisplay.textContent = text;
        // å‰ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã€æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¨­å®š
        feedbackDisplay.className = 'show ' + type; // typeã¯ 'critical', 'perfect' ãªã©CSSã‚¯ãƒ©ã‚¹å
        // ä¸€å®šæ™‚é–“å¾Œã«éè¡¨ç¤º
        setTimeout(() => {
            feedbackDisplay.className = ''; // ã‚¯ãƒ©ã‚¹ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦éè¡¨ç¤ºï¼†ã‚¹ã‚¿ã‚¤ãƒ«ãƒªã‚»ãƒƒãƒˆ
        }, 800); // 0.8ç§’è¡¨ç¤º
    }

    function showQuestion() { /* ... å‰å›ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å¤‰æ›´ãªã— ... */ battleInProgress = false; if (currentProblemIndex >= problems.length || playerHP <= 0 || enemyHP <= 0) { endBattle(); return; } const p = problems[currentProblemIndex]; questionDiv.textContent = p.q; questionStartTime = Date.now(); battleLog.textContent = `Lv${currentStage} (${currentProblemIndex + 1}/${totalQuestionsPerStage}) å•é¡Œï¼`; const choices = generateChoices(p.a); answerChoicesDiv.innerHTML = ""; choices.forEach(choice => { const btn = document.createElement("button"); btn.textContent = choice; btn.className = "choice-btn"; btn.onclick = () => handleAnswer(choice); answerChoicesDiv.appendChild(btn); }); }

    function handleAnswer(selectedAnswer) {
        if (battleInProgress) return;
        battleInProgress = true;
        const choiceButtons = answerChoicesDiv.querySelectorAll('.choice-btn');
        choiceButtons.forEach(btn => btn.disabled = true);

        const elapsed = (Date.now() - questionStartTime) / 1000;
        const p = problems[currentProblemIndex];
        let feedbackClass = ''; let damageToEnemy = 0; let damageToPlayer = 0;
        let logMessage = "";
        let feedbackText = ""; // â˜…è¿½åŠ : ç”»é¢ä¸­å¤®ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
        let feedbackType = ""; // â˜…è¿½åŠ : ç”»é¢ä¸­å¤®ç”¨CSSã‚¯ãƒ©ã‚¹

        // ãƒ¢ãƒ¼ãƒ‰åˆ¥åŸºæº–å€¤ (å¤‰æ›´ãªã—)
        let criticalTime, perfectTime, greatTime, goodTime, slowPenalty, wrongPenalty;
        if (gameMode === 'grade1') { criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0; slowPenalty = 1; wrongPenalty = 2; }
        else { criticalTime = 0.8; perfectTime = 1.5; greatTime = 2.5; goodTime = 4.0; slowPenalty = 2; wrongPenalty = 3; }

        if (selectedAnswer === p.a) { // æ­£è§£
            comboCount++;
            let baseDamage = 0;
            if (elapsed < criticalTime) {
                baseDamage = (gameMode === 'grade1' ? 5 : 6);
                logMessage = `âœ¨Critical Hit!âœ¨ (${elapsed.toFixed(1)}ç§’) `;
                feedbackText = "Critical Hit!"; feedbackType = "critical"; // â˜…è¿½åŠ 
            } else if (elapsed < perfectTime) {
                baseDamage = (gameMode === 'grade1' ? 3 : 4);
                logMessage = `Perfect! (${elapsed.toFixed(1)}ç§’) `;
                feedbackText = "Perfect!"; feedbackType = "perfect"; // â˜…è¿½åŠ 
            } else if (elapsed < greatTime) {
                baseDamage = (gameMode === 'grade1' ? 2 : 2);
                logMessage = `Great! (${elapsed.toFixed(1)}ç§’) `;
                feedbackText = "Great!"; feedbackType = "great"; // â˜…è¿½åŠ 
            } else if (elapsed < goodTime) {
                baseDamage = 1;
                logMessage = `Good (${elapsed.toFixed(1)}ç§’) `;
                feedbackText = "Good"; feedbackType = "good"; // â˜…è¿½åŠ 
            } else {
                damageToPlayer = slowPenalty;
                logMessage = `Too slow... (${elapsed.toFixed(1)}ç§’) è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
                feedbackText = "Too Slow..."; feedbackType = "slow"; // â˜…è¿½åŠ 
                comboCount = 0;
            }

            let comboBonus = 0;
            if (comboCount >= 5) comboBonus = 2; else if (comboCount >= 3) comboBonus = 1;
            damageToEnemy = baseDamage + comboBonus;

            if(damageToEnemy > 0) {
                 logMessage += `æ•µã«${damageToEnemy}ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
                 if (comboCount >= 3) logMessage += ` (${comboCount} Combo!)`;
                 feedbackClass = 'feedback-flash'; // â˜…å¤‰æ›´: ãƒ’ãƒƒãƒˆæ™‚ã¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
                 shakeCharacter('enemyCharacter');
            } else if (damageToPlayer > 0) {
                feedbackClass = 'feedback-damage-player'; // è‡ªåˆ†ãƒ€ãƒ¡ãƒ¼ã‚¸ã¯èƒŒæ™¯èµ¤
                shakeCharacter('playerCharacter');
            } else { feedbackClass = 'feedback-correct'; } // Goodã§ãƒ€ãƒ¡ãƒ¼ã‚¸0ã®å ´åˆ

        } else { // ä¸æ­£è§£
            damageToPlayer = wrongPenalty;
            logMessage = `Wrong! è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
            feedbackText = "Wrong!"; feedbackType = "wrong"; // â˜…è¿½åŠ 
            feedbackClass = 'feedback-wrong'; // èƒŒæ™¯èµ¤
            comboCount = 0;
            shakeCharacter('playerCharacter');
        }

        enemyHP -= damageToEnemy; playerHP -= damageToPlayer;
        enemyHPText.textContent = Math.max(0, enemyHP); playerHPText.textContent = Math.max(0, playerHP);
        updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP);
        battleLog.textContent = logMessage;

        // ç”»é¢ä¸­å¤®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        if(feedbackText) showFeedback(feedbackText, feedbackType);

        // èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        if (feedbackClass) {
            document.body.classList.add(feedbackClass);
            setTimeout(() => { document.body.classList.remove(feedbackClass); }, 150); // â˜…å¤‰æ›´: ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ™‚é–“ã‚’çŸ­ã(0.15s)
        }

        currentProblemIndex++;
        setTimeout(() => { if (playerHP <= 0 || enemyHP <= 0 || currentProblemIndex >= problems.length) { endBattle(); } else { showQuestion(); } }, 1000);
    }

    function startBattle() {
        currentEnemy = enemies[currentStage] || enemies[maxStage];
        enemyMaxHP = currentEnemy.hp;
        if (gameMode === 'grade1') { enemyMaxHP = Math.max(5, Math.floor(enemyMaxHP * 0.7)); }
        enemyHP = enemyMaxHP;
        playerHP = playerMaxHP;
        currentProblemIndex = 0; comboCount = 0;
        problems = generateProblems(currentStage, gameMode);

        // --- èƒŒæ™¯ã¨æ•µè¡¨ç¤ºã®æ›´æ–° ---
        enemyName.textContent = `${currentEnemy.emoji} ${currentEnemy.name} (Lv${currentStage})`;
        enemyHPText.textContent = enemyHP; playerHPText.textContent = playerHP;
        updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP);
        enemyCharacter.textContent = currentEnemy.emoji;
        enemyCharacter.classList.remove('defeated'); // â˜…è¿½åŠ : å¿µã®ãŸã‚æ’ƒç ´çŠ¶æ…‹è§£é™¤

        // ãƒœã‚¹æˆ¦ã®èƒŒæ™¯è‰²ã¨ã‚»ãƒªãƒ•
        if (currentEnemy.type === 'boss') {
            document.body.classList.add('boss-battle-bg'); // ãƒœã‚¹èƒŒæ™¯ã‚¯ãƒ©ã‚¹è¿½åŠ 
            battleLog.textContent = `ğŸ”¥ãƒœã‚¹å‡ºç¾ï¼ ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼ğŸ”¥`;
        } else {
            document.body.classList.remove('boss-battle-bg'); // é€šå¸¸èƒŒæ™¯ã«æˆ»ã™
            battleLog.textContent = `Lv${currentStage} ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`;
        }
        // --- ã“ã“ã¾ã§ ---

        startBtn.style.display = "none";
        battleInProgress = false;
        setTimeout(showQuestion, 1500); // â˜…å¤‰æ›´: ç™»å ´æ¼”å‡ºã®é–“ã‚’å°‘ã—é•·ã
    }

    function endBattle() {
        battleInProgress = true;
        answerChoicesDiv.innerHTML = "";
        questionDiv.textContent = "Battle End!";

        let resultMessage = "";
        let nextButtonText = "";
        let isVictory = false; // å‹åˆ©ãƒ•ãƒ©ã‚°

        if (enemyHP <= 0) { // å‹åˆ©
            isVictory = true;
            // --- æ•µæ’ƒç ´æ¼”å‡º ---
            enemyCharacter.classList.add('defeated'); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¯ãƒ©ã‚¹è¿½åŠ 
            // --- ã“ã“ã¾ã§ ---
            resultMessage = `ğŸ‰å‹åˆ©ï¼ ${currentEnemy.name} ã‚’ãŸãŠã—ãŸï¼ğŸ‰`;
             // ãƒœã‚¹æ’ƒç ´æ™‚ã®ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (currentEnemy.type === 'boss') {
                 resultMessage += ` ã™ã”ã„ï¼ãƒœã‚¹ã‚’æ’ƒç ´ã—ãŸãï¼`;
            }
            currentStage++;
            if (currentStage > maxStage) {
                resultMessage += " ğŸ†å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼ğŸ†";
                startBtn.style.display = "none";
            } else {
                nextButtonText = `æ¬¡ã®æ•µ (Lv${currentStage}) ã¨æˆ¦ã†ï¼`;
                startBtn.style.display = "inline-block";
            }
        } else { // æ•—åŒ— or å•é¡Œåˆ‡ã‚Œ
             resultMessage = playerHP <= 0 ? "ğŸ˜­æ•—åŒ—...ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼" : "æ™‚é–“åˆ‡ã‚Œ...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼";
             nextButtonText = "å†æŒ‘æˆ¦ï¼";
             startBtn.style.display = "inline-block";
        }

        battleLog.textContent = resultMessage;
        if (nextButtonText) { startBtn.textContent = nextButtonText; }

        // å‹åˆ©/æ•—åŒ—ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ (èƒŒæ™¯è‰²)
        document.body.classList.add(isVictory ? 'feedback-correct' : 'feedback-wrong');
        setTimeout(() => {
            document.body.classList.remove('feedback-correct', 'feedback-wrong');
            // é€šå¸¸èƒŒæ™¯ã«æˆ»ã™ï¼ˆãƒœã‚¹æˆ¦å¾Œãªã©ï¼‰
            document.body.classList.remove('boss-battle-bg');
        }, 1000); // 1ç§’è¡¨ç¤º

    }

    // --- ãƒ¢ãƒ¼ãƒ‰é¸æŠå‡¦ç† (å¤‰æ›´ãªã—) ---
    function selectMode(selectedMode) { gameMode = selectedMode; modeSelectScreen.style.display = 'none'; battleScreen.style.display = 'flex'; currentStage = 1; startBattle(); }
    grade1ModeBtn.addEventListener("click", () => selectMode('grade1'));
    grade4ModeBtn.addEventListener("click", () => selectMode('grade4'));
    startBtn.addEventListener("click", () => {
        // æ¬¡ã¸/å†æŒ‘æˆ¦ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã€æ•µã®æ’ƒç ´çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        enemyCharacter.classList.remove('defeated');
        startBattle();
    });

    // åˆæœŸè¡¨ç¤ºè¨­å®š
    playerHPText.textContent = playerHP;
    updateHPBar('playerHPBar', playerHP, playerMaxHP);

  </script>
</body>
</html>
