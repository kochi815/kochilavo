<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            text-align: center;
            background-color: #fdf6e3; /* åŸºæœ¬ã®èƒŒæ™¯è‰² */
            margin: 0;
            padding: 15px; /* å°‘ã—æ¸›ã‚‰ã™ */
            transition: background-color 0.15s ease-out;
        }
        h1 {
            font-size: 1.8em; /* å°‘ã—èª¿æ•´ */
            color: #d35400;
            margin-bottom: 10px; /* èª¿æ•´ */
        }

        /* --- ãƒãƒˆãƒ«ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        #battleScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px; /* è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
        }

        /* --- æ•µãƒ»ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ --- */
        .character-area {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 10px;
            margin: 5px 0;
            width: 90%;
            max-width: 400px;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #enemyArea { border-color: #e74c3c; } /* æ•µã¯èµ¤ç³» */
        #playerArea { border-color: #3498db; } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯é’ç³» */

        .character-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .character-name { font-size: 1.1em; }
        .character-hp-text { font-size: 1em; }

        /* --- HPãƒãƒ¼ --- */
        .hp-bar-container {
            height: 15px; /* ãƒãƒ¼ã®é«˜ã• */
            background-color: #eee;
            border-radius: 8px;
            overflow: hidden; /* ä¸­èº«ãŒã¯ã¿å‡ºãªã„ã‚ˆã†ã« */
            border: 1px solid #ddd;
        }
        .hp-bar {
            height: 100%;
            background-color: #4caf50; /* ç·‘è‰² */
            width: 100%; /* åˆæœŸå€¤ */
            border-radius: 6px;
            transition: width 0.3s ease-in-out; /* å¹…å¤‰åŒ–ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        }
        #enemyArea .hp-bar { background-color: #f44336; } /* æ•µã¯èµ¤ */
        #playerArea .hp-bar { background-color: #4caf50; } /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç·‘ */

        /* --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º (çµµæ–‡å­—) --- */
        .character-display {
            font-size: 3em; /* çµµæ–‡å­—ã‚µã‚¤ã‚º */
            margin: 5px 0;
            /* ãƒ€ãƒ¡ãƒ¼ã‚¸æ™‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
            transition: transform 0.1s ease-in-out;
        }

        /* --- å•é¡Œãƒ»å›ç­”ã‚¨ãƒªã‚¢ --- */
        #question {
            font-size: 2.2em; /* èª¿æ•´ */
            margin: 15px 0; /* èª¿æ•´ */
            color: #2c3e50;
            font-weight: 700;
            min-height: 1.3em;
        }
        #answerChoices {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px; /* èª¿æ•´ */
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .choice-btn {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 1.3em; /* èª¿æ•´ */
            padding: 10px 18px; /* èª¿æ•´ */
            border-radius: 8px; /* èª¿æ•´ */
            border: 2px solid #f39c12;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            min-width: 70px; /* èª¿æ•´ */
            transition: background-color 0.2s, transform 0.1s;
        }
        .choice-btn:hover:not(:disabled) { background-color: #fef9e7; }
        .choice-btn:active:not(:disabled) { transform: scale(0.96); }
        .choice-btn:disabled { background-color: #eee; border-color: #ccc; color: #aaa; cursor: not-allowed; }

        #battleLog {
            font-size: 1.1em; /* èª¿æ•´ */
            min-height: 1.5em; /* èª¿æ•´ */
            margin: 10px 0;
            color: #c0392b;
            font-weight: bold;
        }

        #startBtn { /* ã¾ãŸã¯ gameCtrlBtn */
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-size: 1.1em; /* èª¿æ•´ */
            padding: 10px 30px; /* èª¿æ•´ */
            margin: 15px 0 5px 0; /* ä¸Šãƒãƒ¼ã‚¸ãƒ³è¿½åŠ  */
            border-radius: 20px;
            border: none;
            background-color: #e67e22;
            color: white;
            font-weight: bold;
            cursor: pointer;
            min-width: 160px; /* èª¿æ•´ */
            transition: background-color 0.2s, transform 0.1s;
        }
        #startBtn:hover { background-color: #d35400; }
        #startBtn:active { transform: scale(0.97); }

        /* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            50% { transform: translateX(3px); }
            75% { transform: translateX(-3px); }
        }
        .shake-animation {
            animation: shake 0.2s ease-in-out;
        }

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨èƒŒæ™¯è‰²ã‚¯ãƒ©ã‚¹ (å¤‰æ›´ãªã—) */
        body.feedback-correct { background-color: #dff0d8; }
        body.feedback-wrong { background-color: #f2dede; }
        body.feedback-damage-player { background-color: #f2dede; }
        body.feedback-damage-enemy { background-color: #dff0d8; }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– (ç°¡æ˜“) */
        @media (max-width: 600px) {
            h1 { font-size: 1.6em; }
            .character-display { font-size: 2.5em; }
            #question { font-size: 1.8em; }
            .choice-btn { font-size: 1.1em; padding: 8px 15px; min-width: 60px; }
            #startBtn { font-size: 1em; padding: 10px 25px; min-width: 140px; }
            #battleLog { font-size: 1em; }
        }
    </style>
</head>
<body>
    <h1>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>

    <div id="battleScreen">
        <div id="enemyArea" class="character-area">
            <div class="character-info">
                <span class="character-name" id="enemyName">ğŸ¶ ã„ã¬Lv1</span>
                <span class="character-hp-text">HP: <span id="enemyHPText">10</span></span>
            </div>
            <div class="hp-bar-container">
                <div class="hp-bar" id="enemyHPBar"></div>
            </div>
            <div class="character-display" id="enemyCharacter">ğŸ¶</div>
        </div>

        <div id="questionArea">
            <div id="question">å•é¡Œè¡¨ç¤º</div>
            <div id="answerChoices"></div>
        </div>

        <div id="playerArea" class="character-area">
             <div class="character-display" id="playerCharacter">ğŸ˜º</div>
            <div class="hp-bar-container">
                <div class="hp-bar" id="playerHPBar"></div>
            </div>
            <div class="character-info">
                <span class="character-name">ã«ã‚ƒã‚“ãŸã‚ã†</span>
                <span class="character-hp-text">HP: <span id="playerHPText">10</span></span>
            </div>
        </div>

        <div id="infoArea">
            <div id="battleLog">æˆ¦é—˜ãƒ­ã‚°</div>
            <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
    </div>

  <script>
    const totalQuestionsPerStage = 10; // ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã®å•é¡Œæ•°
    let currentStage = 1; // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«
    let playerMaxHP = 10; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æœ€å¤§HP
    let playerHP = playerMaxHP;
    let currentEnemy = {}; // ç¾åœ¨ã®æ•µæƒ…å ±
    let enemyMaxHP = 10; // æ•µã®æœ€å¤§HPï¼ˆHPãƒãƒ¼è¨ˆç®—ç”¨ï¼‰
    let enemyHP = enemyMaxHP;
    let problems = []; // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã®å•é¡Œ
    let currentProblemIndex = 0; // ç¾åœ¨ã®å•é¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    let questionStartTime; // å•é¡Œè¡¨ç¤ºæ™‚åˆ»
    let battleInProgress = false; // å›ç­”å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
    let comboCount = 0; // é€£ç¶šæ­£è§£æ•°

    // DOMè¦ç´ å–å¾—
    const startBtn = document.getElementById("startBtn");
    const questionDiv = document.getElementById("question");
    const answerChoicesDiv = document.getElementById("answerChoices");
    const battleLog = document.getElementById("battleLog");
    // æ•µé–¢é€£
    const enemyArea = document.getElementById("enemyArea");
    const enemyName = document.getElementById("enemyName");
    const enemyHPText = document.getElementById("enemyHPText");
    const enemyHPBar = document.getElementById("enemyHPBar");
    const enemyCharacter = document.getElementById("enemyCharacter");
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é–¢é€£
    const playerArea = document.getElementById("playerArea");
    const playerHPText = document.getElementById("playerHPText");
    const playerHPBar = document.getElementById("playerHPBar");
    const playerCharacter = document.getElementById("playerCharacter"); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒ©è¡¨ç¤ºç”¨

    // --- æ•µãƒ‡ãƒ¼ã‚¿å®šç¾© ---
    const enemies = {
        // Lv1-4: ã„ã¬
        1: { name: "ã„ã¬", emoji: "ğŸ¶", hp: 12, type: "normal" },
        2: { name: "ã„ã¬", emoji: "ğŸ¶", hp: 15, type: "normal" },
        3: { name: "ã„ã¬", emoji: "ğŸ¶", hp: 18, type: "normal" },
        4: { name: "ã„ã¬", emoji: "ğŸ¶", hp: 22, type: "normal" },
        // Lv5: ãƒœã‚¹ã‚ªã‚ªã‚«ãƒŸ
        5: { name: "ãƒœã‚¹ã‚ªã‚ªã‚«ãƒŸ", emoji: "ğŸº", hp: 35, type: "boss" },
        // Lv6-9: ãã¾
        6: { name: "ãã¾", emoji: "ğŸ»", hp: 30, type: "normal" },
        7: { name: "ãã¾", emoji: "ğŸ»", hp: 35, type: "normal" },
        8: { name: "ãã¾", emoji: "ğŸ»", hp: 40, type: "normal" },
        9: { name: "ãã¾", emoji: "ğŸ»", hp: 45, type: "normal" },
        // Lv10: ãƒœã‚¹ã‚´ãƒªãƒ©
        10: { name: "ãƒœã‚¹ã‚´ãƒªãƒ©", emoji: "ğŸ¦", hp: 60, type: "boss" },
         // Lv11-14: ã‚¹ãƒ©ã‚¤ãƒ  (ä¾‹)
        11: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 50, type: "normal" },
        12: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 55, type: "normal" },
        13: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 60, type: "normal" },
        14: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 65, type: "normal" },
        // Lv15: ãƒœã‚¹ã‚­ãƒ³ã‚°ã‚¹ãƒ©ã‚¤ãƒ 
        15: { name: "ãƒœã‚¹ã‚­ãƒ³ã‚°ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ‘‘ğŸ’§", hp: 90, type: "boss" },
        // Lv16~ ã¯ã•ã‚‰ã«è¿½åŠ å¯èƒ½
    };
    const maxStage = Object.keys(enemies).length; // æœ€å¤§ã‚¹ãƒ†ãƒ¼ã‚¸æ•°

    // --- å•é¡Œç”Ÿæˆé–¢æ•° (é›£æ˜“åº¦ä¸Šæ˜‡å¯¾å¿œ) ---
    function generateProblems(stage) {
        const generatedProblems = [];
        const count = totalQuestionsPerStage; // ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã®å•é¡Œæ•°

        // é›£æ˜“åº¦ã«å¿œã˜ãŸå•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
        let num1, num2, answer, questionText, type;

        for (let i = 0; i < count; i++) {
            if (stage <= 3) { // Lv1-3: ç°¡å˜ãªè¶³ã—ç®— (ç¹°ã‚Šä¸ŠãŒã‚Šãªã—)
                type = '+';
                do {
                    num1 = Math.floor(Math.random() * 9) + 1; // 1-9
                    num2 = Math.floor(Math.random() * (10 - num1)); // ä¾‹: num1=3ãªã‚‰num2=0-6
                } while (num1 + num2 >= 10); // ç¹°ã‚Šä¸ŠãŒã‚Šãªã—ã‚’ä¿è¨¼ (num2ã®ç¯„å›²ã§ã»ã¼ä¿è¨¼)
                answer = num1 + num2;
            } else if (stage <= 6) { // Lv4-6: è¶³ã—ç®— (ç¹°ã‚Šä¸ŠãŒã‚Šã‚ã‚Š)
                type = '+';
                num1 = Math.floor(Math.random() * 9) + 1; // 1-9
                num2 = Math.floor(Math.random() * 9) + 1; // 1-9
                answer = num1 + num2;
            } else if (stage <= 10) { // Lv7-10: å¼•ãç®— (ç­”ãˆ >= 0)
                type = '-';
                num1 = Math.floor(Math.random() * 9) + 1; // 1-9
                num2 = Math.floor(Math.random() * num1) + 1; // num1ä»¥ä¸‹ã®æ•° (1~)
                answer = num1 - num2;
            } else if (stage <= 15) { // Lv11-15: æ›ã‘ç®— (1æ¡ x 1æ¡)
                type = 'Ã—';
                num1 = Math.floor(Math.random() * 8) + 2; // 2-9
                num2 = Math.floor(Math.random() * 8) + 2; // 2-9
                answer = num1 * num2;
            } else { // Lv16ä»¥ä¸Š: 2æ¡ + 1æ¡ (ä¾‹) - ã“ã“ã‹ã‚‰ã•ã‚‰ã«è¤‡é›‘åŒ–
                type = '+';
                num1 = Math.floor(Math.random() * 90) + 10; // 10-99
                num2 = Math.floor(Math.random() * 9) + 1;   // 1-9
                answer = num1 + num2;
                // ã•ã‚‰ã«å‰²ã‚Šç®—ã‚„è™«é£Ÿã„ç®—ãªã©ã‚’è¿½åŠ 
            }
            questionText = `${num1} ${type} ${num2}`;
            generatedProblems.push({ q: questionText, a: answer });
        }

        // Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ«
        for (let i = generatedProblems.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [generatedProblems[i], generatedProblems[j]] = [generatedProblems[j], generatedProblems[i]];
        }
        return generatedProblems;
    }

    // é¸æŠè‚¢ç”Ÿæˆé–¢æ•° (å¤‰æ›´ãªã—)
    function generateChoices(correct) {
      const choices = new Set(); choices.add(correct);
      let attempts = 0;
      while (choices.size < 6 && attempts < 50) {
        const delta = Math.floor(Math.random() * 10) - 5 + (Math.random() < 0.5 ? 10 : -10); // èª¤ç­”ã®å¹…ã‚’å°‘ã—åºƒã’ã‚‹
        const choice = correct + delta;
        if (choice !== correct && choice >= 0 && !choices.has(choice)) { choices.add(choice); } // 0ä»¥ä¸Šã‚’è¨±å¯
        attempts++;
      }
      while (choices.size < 6) { choices.add(Math.max(0, correct + choices.size + Math.floor(Math.random()*3))); } // 0ä»¥ä¸Šã‚’ä¿è¨¼
      const choiceArray = Array.from(choices);
      choiceArray.sort(() => Math.random() - 0.5);
      return choiceArray;
    }

    // HPãƒãƒ¼æ›´æ–°é–¢æ•°
    function updateHPBar(elementId, currentHP, maxHP) {
        const bar = document.getElementById(elementId);
        const percentage = Math.max(0, (currentHP / maxHP) * 100);
        bar.style.width = `${percentage}%`;
    }

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
    function shakeCharacter(elementId) {
        const characterElement = document.getElementById(elementId);
        characterElement.classList.add('shake-animation');
        setTimeout(() => {
            characterElement.classList.remove('shake-animation');
        }, 200); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“(0.2s)å¾Œã«ã‚¯ãƒ©ã‚¹å‰Šé™¤
    }


    function showQuestion() {
        battleInProgress = false;

        if (currentProblemIndex >= problems.length || playerHP <= 0 || enemyHP <= 0) {
            endBattle();
            return;
        }
        const p = problems[currentProblemIndex];
        questionDiv.textContent = p.q;
        questionStartTime = Date.now();
        battleLog.textContent = `Lv${currentStage} (${currentProblemIndex + 1}/${totalQuestionsPerStage}) å•é¡Œï¼`;

        const choices = generateChoices(p.a);
        answerChoicesDiv.innerHTML = "";
        choices.forEach(choice => {
            const btn = document.createElement("button");
            btn.textContent = choice;
            btn.className = "choice-btn";
            btn.onclick = () => handleAnswer(choice);
            answerChoicesDiv.appendChild(btn);
        });
    }

    function handleAnswer(selectedAnswer) {
        if (battleInProgress) return;
        battleInProgress = true;

        const choiceButtons = answerChoicesDiv.querySelectorAll('.choice-btn');
        choiceButtons.forEach(btn => btn.disabled = true);

        const elapsed = (Date.now() - questionStartTime) / 1000;
        const p = problems[currentProblemIndex];
        let feedbackClass = '';
        let damageToEnemy = 0;
        let damageToPlayer = 0;
        let logMessage = "";

        if (selectedAnswer === p.a) {
            // æ­£è§£
            comboCount++; // ã‚³ãƒ³ãƒœã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
            let baseDamage = 0;
            const criticalTime = 0.8; // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ’ãƒƒãƒˆåˆ¤å®šæ™‚é–“ (0.8ç§’)
            const perfectTime = 1.5; // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆåˆ¤å®šæ™‚é–“
            const greatTime = 2.5;   // ã‚°ãƒ¬ãƒ¼ãƒˆåˆ¤å®šæ™‚é–“
            const goodTime = 4.0;    // ã‚°ãƒƒãƒ‰åˆ¤å®šæ™‚é–“

            if (elapsed < criticalTime) {
                baseDamage = 6; // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ’ãƒƒãƒˆãƒ€ãƒ¡ãƒ¼ã‚¸
                logMessage = `âœ¨Critical Hit!âœ¨ (${elapsed.toFixed(1)}ç§’) `;
                feedbackClass = 'feedback-correct'; // æ­£è§£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å„ªå…ˆ
            } else if (elapsed < perfectTime) {
                baseDamage = 4;
                logMessage = `Perfect! (${elapsed.toFixed(1)}ç§’) `;
                feedbackClass = 'feedback-correct';
            } else if (elapsed < greatTime) {
                baseDamage = 2;
                logMessage = `Great! (${elapsed.toFixed(1)}ç§’) `;
                feedbackClass = 'feedback-correct';
            } else if (elapsed < goodTime) {
                baseDamage = 1;
                logMessage = `Good (${elapsed.toFixed(1)}ç§’) `;
                feedbackClass = 'feedback-correct';
            } else {
                // æ™‚é–“ãŒã‹ã‹ã‚Šã™ããŸãƒšãƒŠãƒ«ãƒ†ã‚£
                damageToPlayer = 2;
                logMessage = `Too slow... (${elapsed.toFixed(1)}ç§’) è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
                feedbackClass = 'feedback-damage-player';
                comboCount = 0; // ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
            }

            // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ï¼ˆä¾‹: 3ã‚³ãƒ³ãƒœä»¥ä¸Šã§ãƒ€ãƒ¡ãƒ¼ã‚¸+1ã€5ã‚³ãƒ³ãƒœä»¥ä¸Šã§+2ï¼‰
            let comboBonus = 0;
            if (comboCount >= 5) {
                comboBonus = 2;
            } else if (comboCount >= 3) {
                comboBonus = 1;
            }
            damageToEnemy = baseDamage + comboBonus;

            if(damageToEnemy > 0) {
                 logMessage += `æ•µã«${damageToEnemy}ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
                 if (comboCount >= 3) logMessage += ` (${comboCount} Combo!)`;
                 feedbackClass = 'feedback-damage-enemy'; // ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                 shakeCharacter('enemyCharacter'); // æ•µã‚’æºã‚‰ã™
            } else if (damageToPlayer > 0) {
                shakeCharacter('playerCharacter'); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æºã‚‰ã™
            }

        } else {
            // ä¸æ­£è§£
            damageToPlayer = 3; // ä¸æ­£è§£æ™‚ã®ãƒ€ãƒ¡ãƒ¼ã‚¸
            logMessage = `Wrong! è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
            feedbackClass = 'feedback-wrong';
            comboCount = 0; // ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
            shakeCharacter('playerCharacter'); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æºã‚‰ã™
        }

        // HPåæ˜ 
        enemyHP -= damageToEnemy;
        playerHP -= damageToPlayer;

        // HPè¡¨ç¤ºæ›´æ–°
        enemyHPText.textContent = Math.max(0, enemyHP);
        playerHPText.textContent = Math.max(0, playerHP);
        updateHPBar('enemyHPBar', enemyHP, enemyMaxHP);
        updateHPBar('playerHPBar', playerHP, playerMaxHP);

        // ãƒ­ã‚°è¡¨ç¤º
        battleLog.textContent = logMessage;

        // è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        if (feedbackClass) {
            document.body.classList.add(feedbackClass);
            setTimeout(() => {
                document.body.classList.remove(feedbackClass);
            }, 300);
        }

        currentProblemIndex++;

        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®å•é¡Œã¸
        setTimeout(() => {
            // HPãƒã‚§ãƒƒã‚¯ã—ã¦æˆ¦é—˜çµ‚äº†åˆ¤å®šã‚‚ã“ã“ã§è¡Œã†
            if (playerHP <= 0 || enemyHP <= 0 || currentProblemIndex >= problems.length) {
                 endBattle();
            } else {
                 showQuestion();
            }
        }, 1000); // å¾…ã¡æ™‚é–“ã‚’1ç§’ã«å¤‰æ›´
    }

    function startBattle() {
        currentEnemy = enemies[currentStage] || enemies[maxStage]; // ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸ã®æ•µ or æœ€å¤§ã‚¹ãƒ†ãƒ¼ã‚¸ã®æ•µ
        enemyMaxHP = currentEnemy.hp;
        enemyHP = enemyMaxHP;
        playerHP = playerMaxHP; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HPãƒªã‚»ãƒƒãƒˆ
        currentProblemIndex = 0;
        comboCount = 0; // ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ
        problems = generateProblems(currentStage); // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸå•é¡Œã‚’ç”Ÿæˆ

        // UIæ›´æ–°
        enemyName.textContent = `${currentEnemy.emoji} ${currentEnemy.name} (Lv${currentStage})`;
        enemyHPText.textContent = enemyHP;
        playerHPText.textContent = playerHP;
        updateHPBar('enemyHPBar', enemyHP, enemyMaxHP);
        updateHPBar('playerHPBar', playerHP, playerMaxHP);
        enemyCharacter.textContent = currentEnemy.emoji; // æ•µã‚­ãƒ£ãƒ©è¡¨ç¤ºæ›´æ–°

        startBtn.style.display = "none";
        battleLog.textContent = `Lv${currentStage} ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`;
        battleInProgress = false;

        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æœ€åˆã®å•é¡Œè¡¨ç¤ºï¼ˆç™»å ´æ¼”å‡ºï¼‰
        setTimeout(() => {
             showQuestion();
        }, 1000); // 1ç§’å¾…ã¤
    }

    function endBattle() {
        battleInProgress = true;
        answerChoicesDiv.innerHTML = "";
        questionDiv.textContent = "Battle End!";

        let resultMessage = "";
        let nextButtonText = "";

        if (enemyHP <= 0) {
            resultMessage = `å‹åˆ©ï¼ ${currentEnemy.name} ã‚’ãŸãŠã—ãŸï¼`;
            currentStage++;
            if (currentStage > maxStage) {
                resultMessage += " å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼";
                startBtn.style.display = "none";
            } else {
                nextButtonText = `æ¬¡ã®æ•µ (Lv${currentStage}) ã¨æˆ¦ã†ï¼`;
                startBtn.style.display = "inline-block";
            }
            // å‹åˆ©æ™‚ã«ã‚‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
             document.body.classList.add('feedback-correct');
             setTimeout(() => document.body.classList.remove('feedback-correct'), 500);
        } else { // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP <= 0 ã¾ãŸã¯ å•é¡Œåˆ‡ã‚Œ
             resultMessage = playerHP <= 0 ? "æ•—åŒ—...ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼" : "æ™‚é–“åˆ‡ã‚Œ...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼";
             nextButtonText = "å†æŒ‘æˆ¦ï¼";
             // æ•—åŒ—æ™‚ã¯æœ€åˆã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ã«ã™ã‚‹ã‹ã€åŒã˜ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰ã«ã™ã‚‹ã‹
             // currentStage = 1; // æœ€åˆã‹ã‚‰ã«ã™ã‚‹å ´åˆ
             startBtn.style.display = "inline-block";
             // æ•—åŒ—æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
             document.body.classList.add('feedback-wrong');
             setTimeout(() => document.body.classList.remove('feedback-wrong'), 500);
        }

        battleLog.textContent = resultMessage;
        if (nextButtonText) {
            startBtn.textContent = nextButtonText;
        }
    }

    startBtn.addEventListener("click", startBattle);

    // åˆæœŸè¡¨ç¤ºè¨­å®š
    playerHPText.textContent = playerHP;
    updateHPBar('playerHPBar', playerHP, playerMaxHP);
    // æœ€åˆã¯æ•µæƒ…å ±ãªã— or Lv1æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ãŠãã‹ -> startBattleã§è¨­å®šã™ã‚‹ã®ã§ä¸è¦

  </script>
</body>
</html>
