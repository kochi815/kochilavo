<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'M PLUS Rounded 1c', sans-serif;
      text-align: center;
      background-color: #fdf6e3; /* åŸºæœ¬ã®èƒŒæ™¯è‰² */
      margin: 0;
      padding: 20px;
      transition: background-color 0.15s ease-out; /* ä¿®æ­£ç‚¹3: èƒŒæ™¯è‰²å¤‰åŒ–ç”¨ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ */
    }
    h1 {
      font-size: 2em;
      color: #d35400; /* ã‚ªãƒ¬ãƒ³ã‚¸ç³» */
      margin-bottom: 15px;
    }
    /* ä¿®æ­£ç‚¹5: ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤ºå‰Šé™¤ */
    /* #avatarDisplay ã‚¹ã‚¿ã‚¤ãƒ«å‰Šé™¤ */

    #enemyStatus, #playerStatus {
      font-size: 1.1em;
      margin: 10px 0;
      color: #555;
      background-color: rgba(255, 255, 255, 0.7); /* åŠé€æ˜èƒŒæ™¯ã§è¦‹ã‚„ã™ã */
      padding: 5px 10px;
      border-radius: 8px;
      display: inline-block; /* å¹…ã‚’å†…å®¹ã«åˆã‚ã›ã‚‹ */
    }
    #question {
      font-size: 2.5em;
      margin: 25px 0; /* ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
      color: #2c3e50; /* æ¿ƒã„é’ç°è‰² */
      font-weight: 700;
      min-height: 1.3em; /* å°‘ã—èª¿æ•´ */
    }
    #answerChoices {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 15px; /* ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
      margin-bottom: 15px; /* ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
    }
    .choice-btn {
      font-family: 'M PLUS Rounded 1c', sans-serif; /* ãƒ•ã‚©ãƒ³ãƒˆé©ç”¨ */
      font-size: 1.5em;
      padding: 12px 22px; /* å°‘ã—å¤§ãã */
      border-radius: 10px;
      border: 2px solid #f39c12; /* ã‚ªãƒ¬ãƒ³ã‚¸ç³» */
      background-color: #fff;
      color: #333;
      cursor: pointer;
      min-width: 85px; /* å°‘ã—èª¿æ•´ */
      transition: background-color 0.2s, transform 0.1s;
    }
    .choice-btn:hover:not(:disabled) { /* disabledã§ãªã„æ™‚ã ã‘hover */
      background-color: #fef9e7; /* è–„ã„é»„è‰² */
    }
    .choice-btn:active:not(:disabled) { /* disabledã§ãªã„æ™‚ã ã‘active */
        transform: scale(0.96);
    }
    /* ä¿®æ­£ç‚¹3: å›ç­”ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .choice-btn:disabled {
        background-color: #eee;
        border-color: #ccc;
        color: #aaa;
        cursor: not-allowed;
    }

    #battleLog {
      font-size: 1.2em;
      min-height: 2em;
      margin: 15px 0; /* ãƒãƒ¼ã‚¸ãƒ³èª¿æ•´ */
      color: #c0392b; /* èµ¤ç³» */
      font-weight: bold;
    }

    #startBtn { /* åå‰å¤‰æ›´: gameCtrlBtn (æ±ç”¨çš„ãªåå‰ã«) */
      font-family: 'M PLUS Rounded 1c', sans-serif; /* ãƒ•ã‚©ãƒ³ãƒˆé©ç”¨ */
      font-size: 1.2em;
      padding: 12px 35px; /* å°‘ã—å¤§ãã */
      margin: 10px;
      border-radius: 20px;
      border: none;
      background-color: #e67e22; /* ã‚ªãƒ¬ãƒ³ã‚¸ç³» */
      color: white;
      font-weight: bold;
      cursor: pointer;
      min-width: 150px; /* å°‘ã—å¤§ãã */
      transition: background-color 0.2s, transform 0.1s;
    }
    #startBtn:hover { /* gameCtrlBtn */
      background-color: #d35400; /* æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
    }
     #startBtn:active { /* gameCtrlBtn */
        transform: scale(0.97);
    }

    /* ä¿®æ­£ç‚¹3: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨èƒŒæ™¯è‰²ã‚¯ãƒ©ã‚¹ */
    body.feedback-correct { background-color: #dff0d8; } /* è–„ã„ç·‘ */
    body.feedback-wrong { background-color: #f2dede; } /* è–„ã„èµ¤ */
    body.feedback-damage-player { background-color: #f2dede; } /* è–„ã„èµ¤ */
    body.feedback-damage-enemy { background-color: #dff0d8; } /* è–„ã„ç·‘ */


    @media (max-width: 768px) {
      h1 { font-size: 1.8em; }
      #question { font-size: 2em; margin: 20px 0; }
      #battleLog { font-size: 1.1em; }
      #startBtn { font-size: 1em; padding: 10px 25px; min-width: 120px; } /* gameCtrlBtn */
      .choice-btn { font-size: 1.2em; padding: 10px 18px; min-width: 70px; }
    }
  </style>
</head>
<body>
  <h1>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
  <div id="enemyStatus">ğŸ¶ ??? (Lv <span id="enemyLevel">1</span>) - HP: <span id="enemyHP">10</span></div>
  <div id="playerStatus">ğŸ˜º ã«ã‚ƒã‚“ãŸã‚ã† - HP: <span id="playerHP">10</span></div>
  <div id="question">å•é¡Œè¡¨ç¤º</div>
  <div id="answerChoices"></div>
  <div id="battleLog">æˆ¦é—˜ãƒ­ã‚°</div>
  <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

  <script>
    const totalQuestions = 10; // 1ã‚¹ãƒ†ãƒ¼ã‚¸ã‚ãŸã‚Šã®å•é¡Œæ•°
    let problems = [];
    let index = 0;
    let startTime;
    let playerHP = 10;
    let enemyHP = 10;
    let currentStage = 1;
    let battleInProgress = false; // ä¿®æ­£ç‚¹3: å›ç­”å¾Œã®å¾…ã¡æ™‚é–“åˆ¶å¾¡ç”¨

    // DOMè¦ç´ å–å¾—
    const startBtn = document.getElementById("startBtn"); // åå‰ã¯ã“ã®ã¾ã¾ or gameCtrlBtn
    const questionDiv = document.getElementById("question");
    const battleLog = document.getElementById("battleLog");
    const enemyHPDisplay = document.getElementById("enemyHP");
    const enemyLevelDisplay = document.getElementById("enemyLevel");
    const playerHPDisplay = document.getElementById("playerHP");
    // ä¿®æ­£ç‚¹5: avatarDisplay å‰Šé™¤
    const enemyStatus = document.getElementById("enemyStatus");
    const answerChoicesDiv = document.getElementById("answerChoices");

    // ä¿®æ­£ç‚¹5: equipped å¤‰æ•°å‰Šé™¤

    // æ•µãƒªã‚¹ãƒˆ
    const enemyList = Array.from({ length: 30 }, (_, i) => {
      const level = i + 1;
      return {
        name: `ã„ã¬Lv${level}`, emoji: "ğŸ¶", level,
        hp: 10 + Math.floor(level * 1.5)
      };
    });

    // ä¿®æ­£ç‚¹5: updateAvatar é–¢æ•°å‰Šé™¤

    function generateProblems() {
      problems = [];
      // å•é¡Œã®ç¨®é¡ã‚„é›£æ˜“åº¦ã¯ã“ã“ã§èª¿æ•´å¯èƒ½
      for (let a = 2; a < 10; a++) {
        for (let b = 2; b < 10; b++) {
          problems.push({ q: `${a} Ã— ${b}`, a: a * b });
        }
      }
      // --- ä¿®æ­£ç‚¹1: Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ« ---
      for (let i = problems.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [problems[i], problems[j]] = [problems[j], problems[i]];
      }
      // --- ä¿®æ­£ç‚¹1 ã“ã“ã¾ã§ ---
      problems = problems.slice(0, totalQuestions);
    }

    function generateChoices(correct) {
      const choices = new Set();
      choices.add(correct);
      // èª¤ç­”ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (ç¾çŠ¶ç¶­æŒ)
      let attempts = 0; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ç”¨
      while (choices.size < 6 && attempts < 50) {
        const delta = Math.floor(Math.random() * 10) - 5; // æ­£è§£Â±5ã®ç¯„å›²
        const choice = correct + delta;
        // æ­£è§£ã¨åŒã˜ã§ãªãã€0ã‚ˆã‚Šå¤§ããã€ã¾ã ã‚»ãƒƒãƒˆã«ãªã„å€¤ã‚’è¿½åŠ 
        if (choice !== correct && choice > 0 && !choices.has(choice)) {
           choices.add(choice);
        }
        attempts++;
      }
      // ã‚‚ã—6å€‹ç”Ÿæˆã§ããªã‹ã£ãŸå ´åˆï¼ˆãƒ¬ã‚¢ã‚±ãƒ¼ã‚¹ï¼‰ã€é©å½“ãªå€¤ã§åŸ‹ã‚ã‚‹
      while (choices.size < 6) {
        choices.add(Math.max(1, correct + choices.size)); // é©å½“ãªå€¤
      }

      const choiceArray = Array.from(choices);
      choiceArray.sort(() => Math.random() - 0.5); // é¸æŠè‚¢ã®ä½ç½®ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      return choiceArray;
    }

    function showQuestion() {
        // å¾…æ©ŸçŠ¶æ…‹ã‚’è§£é™¤
        battleInProgress = false;

        if (index >= problems.length || playerHP <= 0 || enemyHP <= 0) {
            endBattle();
            return;
        }
        const p = problems[index];
        questionDiv.textContent = p.q;
        startTime = Date.now();
        battleLog.textContent = "è¨ˆç®—ã—ã¦å›ç­”ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã­ï¼"; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´

        const choices = generateChoices(p.a);
        answerChoicesDiv.innerHTML = ""; // å‰ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢
        choices.forEach(choice => {
            const btn = document.createElement("button");
            btn.textContent = choice;
            btn.className = "choice-btn";
            btn.onclick = () => handleAnswer(choice); // onclickã‚’ä½¿ç”¨
            // disabled = false ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãªã®ã§è¨­å®šä¸è¦
            answerChoicesDiv.appendChild(btn);
        });
    }

    function handleAnswer(selectedAnswer) {
        // ä¿®æ­£ç‚¹3: å›ç­”å¾Œã®å¾…ã¡æ™‚é–“åˆ¶å¾¡
        if (battleInProgress) return; // å‡¦ç†ä¸­ã®é€£ç¶šã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡è¦–
        battleInProgress = true; // å‡¦ç†é–‹å§‹

        // å›ç­”ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        const choiceButtons = answerChoicesDiv.querySelectorAll('.choice-btn');
        choiceButtons.forEach(btn => btn.disabled = true);

        const elapsed = (Date.now() - startTime) / 1000;
        const p = problems[index];
        let feedbackClass = ''; // ä¿®æ­£ç‚¹3: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ã‚¯ãƒ©ã‚¹

        if (selectedAnswer === p.a) {
            // æ­£è§£æ™‚ã®å‡¦ç†
            if (elapsed < 1.2) {
                enemyHP -= 5;
                battleLog.textContent = `Perfect! (${elapsed.toFixed(1)}ç§’) æ•µã«5ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
                feedbackClass = 'feedback-damage-enemy';
            } else if (elapsed < 2.0) {
                enemyHP -= 3;
                battleLog.textContent = `Great! (${elapsed.toFixed(1)}ç§’) æ•µã«3ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
                feedbackClass = 'feedback-damage-enemy';
            } else if (elapsed < 3.0) {
                enemyHP -= 1;
                battleLog.textContent = `Good! (${elapsed.toFixed(1)}ç§’) æ•µã«1ãƒ€ãƒ¡ãƒ¼ã‚¸`;
                feedbackClass = 'feedback-damage-enemy';
            } else {
                playerHP -= 2;
                battleLog.textContent = `Too slow... (${elapsed.toFixed(1)}ç§’) ãƒŸã‚¹! è‡ªåˆ†ã«2ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
                feedbackClass = 'feedback-damage-player';
            }
        } else {
            // ä¸æ­£è§£æ™‚ã®å‡¦ç†
            playerHP -= 3;
            battleLog.textContent = `Wrong! (${elapsed.toFixed(1)}ç§’) è‡ªåˆ†ã«3ãƒ€ãƒ¡ãƒ¼ã‚¸!`;
            feedbackClass = 'feedback-wrong';
        }

        // ä¿®æ­£ç‚¹3: è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é©ç”¨
        if (feedbackClass) {
            document.body.classList.add(feedbackClass);
            setTimeout(() => {
                document.body.classList.remove(feedbackClass);
            }, 300); // 0.3ç§’å¾Œã«èƒŒæ™¯è‰²ã‚’æˆ»ã™
        }

        // HPè¡¨ç¤ºæ›´æ–°
        enemyHPDisplay.textContent = Math.max(0, enemyHP);
        playerHPDisplay.textContent = Math.max(0, playerHP);

        index++;

        // ä¿®æ­£ç‚¹3: å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¬¡ã®å•é¡Œã¸
        setTimeout(() => {
            showQuestion(); // 0.75ç§’å¾Œã«æ¬¡ã®å•é¡Œã‚’è¡¨ç¤º
        }, 750);
    }

    function startBattle() {
      const enemy = enemyList[currentStage - 1];
      enemyHP = enemy.hp;
      playerHP = 10; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HPãƒªã‚»ãƒƒãƒˆ
      index = 0;
      generateProblems();
      // ä¿®æ­£ç‚¹5: updateAvatar() å‘¼ã³å‡ºã—å‰Šé™¤
      enemyHPDisplay.textContent = enemy.hp;
      enemyLevelDisplay.textContent = enemy.level;
      // enemyStatus ã®å†…å®¹ã‚’æ›´æ–°
      enemyStatus.innerHTML = `${enemy.emoji} ${enemy.name} (Lv <span id="enemyLevel">${enemy.level}</span>) - HP: <span id="enemyHP">${enemy.hp}</span>`;
      playerHPDisplay.textContent = playerHP; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HPè¡¨ç¤ºã‚‚æ›´æ–°
      startBtn.style.display = "none"; // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’éš ã™
      battleLog.textContent = ""; // ãƒãƒˆãƒ«ãƒ­ã‚°åˆæœŸåŒ–
      battleInProgress = false; // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      showQuestion(); // æœ€åˆã®å•é¡Œè¡¨ç¤º
    }

    function endBattle() {
        battleInProgress = true; // ãƒœã‚¿ãƒ³é€£æ‰“é˜²æ­¢
        answerChoicesDiv.innerHTML = ""; // é¸æŠè‚¢ã‚¯ãƒªã‚¢
        questionDiv.textContent = "Battle End!"; // å•é¡Œè¡¨ç¤ºã‚¯ãƒªã‚¢

        let resultMessage = "";
        let nextButtonText = "";

        if (enemyHP <= 0) {
            // å‹åˆ©
            resultMessage = `å‹åˆ©ï¼ ${enemyList[currentStage - 1].name} ã‚’ãŸãŠã—ãŸï¼`;
            currentStage++;
            if (currentStage > enemyList.length) {
                resultMessage += " å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼";
                startBtn.style.display = "none"; // å…¨ã‚¯ãƒªãªã‚‰ãƒœã‚¿ãƒ³éè¡¨ç¤º
            } else {
                nextButtonText = `æ¬¡ã®æ•µ (Lv${currentStage}) ã¨æˆ¦ã†ï¼`;
                startBtn.style.display = "inline-block";
            }
        } else if (playerHP <= 0) {
            // æ•—åŒ—
            resultMessage = "æ•—åŒ—...ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼";
            nextButtonText = "å†æŒ‘æˆ¦ï¼";
            // currentStageã¯ãã®ã¾ã¾ or 1ã«æˆ»ã™ã‹ã¯ã‚²ãƒ¼ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³æ¬¡ç¬¬
            startBtn.style.display = "inline-block";
        } else {
            // å•é¡Œåˆ‡ã‚Œ (10å•çµ‚äº†) - HPãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆ
            // ã“ã®ã‚±ãƒ¼ã‚¹ã®æ‰±ã„ã‚’ã©ã†ã™ã‚‹ã‹ (å¼•ãåˆ†ã‘ï¼Ÿ æ•—åŒ—ï¼Ÿ)
            // ã“ã“ã§ã¯æ•—åŒ—æ‰±ã„ã¨ã—ã¦å†æŒ‘æˆ¦ã‚’ä¿ƒã™ä¾‹
            resultStage = "å•é¡Œåˆ‡ã‚Œ...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼";
            nextButtonText = "å†æŒ‘æˆ¦ï¼";
            startBtn.style.display = "inline-block";
        }

        battleLog.textContent = resultMessage;
        if (nextButtonText) {
            startBtn.textContent = nextButtonText;
        }
    }

    startBtn.addEventListener("click", () => {
        // ã‚µã‚¦ãƒ³ãƒ‰ã¯ä»Šå›ãªã—
        startBattle();
    });

    // åˆæœŸè¡¨ç¤º
    playerHPDisplay.textContent = playerHP;
    // ä¿®æ­£ç‚¹5: updateAvatar() å‘¼ã³å‡ºã—å‰Šé™¤
    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ•µæƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹å¿…è¦ã¯ãªã„ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
    // const initialEnemy = enemyList[currentStage - 1];
    // enemyHPDisplay.textContent = initialEnemy.hp;
    // enemyLevelDisplay.textContent = initialEnemy.level;
    // enemyStatus.innerHTML = `${initialEnemy.emoji} ${initialEnemy.name} (Lv ${initialEnemy.level}) - HP: <span id="enemyHP">${initialEnemy.hp}</span>`;

  </script>
</body>
</html>
