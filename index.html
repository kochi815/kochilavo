<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ç­‰ --- */
        body { font-family: 'M PLUS Rounded 1c', sans-serif; text-align: center; background-color: #fdf6e3; margin: 0; padding: 15px; transition: background-color 0.3s ease-out; position: relative; min-height: 100vh; box-sizing: border-box; }
        body.boss-battle-bg { background-color: #ffebee; }
        h1 { font-size: 1.8em; color: #d35400; margin-bottom: 10px; }
        button { /* ãƒœã‚¿ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ«å°‘ã—èª¿æ•´ */
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            border: none;
        }
        button:active:not(:disabled) { transform: scale(0.97); }
        button:disabled { cursor: not-allowed; opacity: 0.6; }

        /* --- BGMãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ --- */
        #bgmToggleBtn { position: absolute; top: 15px; right: 15px; font-size: 1.8em; background: none; border: none; padding: 5px; opacity: 0.7; z-index: 20; }
        #bgmToggleBtn:hover { opacity: 1; }
        #bgmToggleBtn.muted::before { content: "ğŸ”‡"; font-size: 1em; }
        #bgmToggleBtn:not(.muted)::before { content: "ğŸ”Š"; font-size: 1em; }

        /* --- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ --- */
        #modeSelectScreen { padding-top: 50px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #modeSelectScreen h2 { font-size: 1.5em; color: #555; }
        .mode-btn { font-size: 1.4em; padding: 15px 40px; border-radius: 25px; color: white; min-width: 250px; }
        #grade1ModeBtn { background-color: #87cefa; } #grade4ModeBtn { background-color: #ffcc80; }
        #grade1ModeBtn:hover { background-color: #5abcd8; } #grade4ModeBtn:hover { background-color: #ffa726; }

        /* --- â˜…è¿½åŠ : ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠç”»é¢ --- */
        #startMethodScreen {
            padding-top: 50px;
            display: none; /* åˆæœŸéè¡¨ç¤º */
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #startMethodScreen h2 { font-size: 1.5em; color: #555; }
        .start-method-btn { /* ã¯ã˜ã‚ã‹ã‚‰/ã¤ã¥ãã‹ã‚‰ ãƒœã‚¿ãƒ³ */
             font-size: 1.4em; padding: 15px 40px; border-radius: 25px; color: white; min-width: 250px;
        }
        #startFromBeginningBtn { background-color: #a5d6a7; } /* ç·‘ç³» */
        #continueFromLastBtn { background-color: #90caf9; } /* é’ç³» */
        #startFromBeginningBtn:hover { background-color: #81c784; }
        #continueFromLastBtn:hover:not(:disabled) { background-color: #64b5f6; }

        /* --- ãƒãƒˆãƒ«ç”»é¢ --- */
        #battleScreen { display: none; flex-direction: column; align-items: center; gap: 10px; }
        /* ... ãƒãƒˆãƒ«ç”»é¢å†…ã®ç´°ã‹ã„ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ï¼ˆå‰å›åŒæ§˜ï¼‰ ... */
        .character-area { border: 2px solid #eee; border-radius: 10px; padding: 10px; margin: 5px 0; width: 90%; max-width: 400px; background-color: rgba(255, 255, 255, 0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; } #enemyArea { border-color: #e74c3c; } #playerArea { border-color: #3498db; } .character-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; } .character-name { font-size: 1.1em; } .character-hp-text { font-size: 1em; } .hp-bar-container { height: 15px; background-color: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; } .hp-bar { height: 100%; width: 100%; border-radius: 6px; transition: width 0.3s ease-in-out; } #enemyArea .hp-bar { background-color: #f44336; } #playerArea .hp-bar { background-color: #4caf50; } .character-display { font-size: 3em; margin: 5px 0; transition: transform 0.1s ease-in-out, opacity 0.3s ease-out; opacity: 1; } .character-display.defeated { opacity: 0; transform: scale(0.5) rotate(30deg); } #question { font-size: 2.2em; margin: 15px 0; color: #2c3e50; font-weight: 700; min-height: 1.3em; } #answerChoices { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; margin-bottom: 10px; } .choice-btn { font-size: 1.3em; padding: 10px 18px; border-radius: 8px; border: 2px solid #f39c12; background-color: #fff; color: #333; min-width: 70px; } .choice-btn:hover:not(:disabled) { background-color: #fef9e7; } .choice-btn:disabled { background-color: #eee; border-color: #ccc; color: #aaa; } #battleLog { font-size: 1.1em; min-height: 1.5em; margin: 10px 0; color: #c0392b; font-weight: bold; } #startBtn { font-size: 1.1em; padding: 10px 30px; margin: 15px 0 5px 0; border-radius: 20px; background-color: #e67e22; color: white; min-width: 160px; } #startBtn:hover { background-color: #d35400; } #feedbackDisplay { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) scale(0.8); font-size: 3em; font-weight: bold; color: #fff; background-color: rgba(0, 0, 0, 0.6); padding: 10px 25px; border-radius: 15px; opacity: 0; transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; z-index: 10; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); } #feedbackDisplay.show { opacity: 1; transform: translate(-50%, -50%) scale(1); } #feedbackDisplay.critical { color: #ffeb3b; } #feedbackDisplay.perfect { color: #81d4fa; } #feedbackDisplay.great { color: #a5d6a7; } #feedbackDisplay.good { color: #fff; } #feedbackDisplay.slow { color: #ef9a9a; } #feedbackDisplay.wrong { color: #f44336; background-color: rgba(255, 255, 255, 0.8); text-shadow: none;} #comboDisplay { position: absolute; top: 60%; left: 50%; transform: translateX(-50%); font-size: 2.5em; font-weight: bold; color: #ff9800; opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; z-index: 5; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); } #comboDisplay.show { opacity: 1; animation: comboBounce 0.3s ease-out; } #comboDisplay.great-combo { color: #f44336; } #comboDisplay.amazing-combo { color: #9c27b0; }
        @keyframes comboBounce { 0% { transform: translateX(-50%) scale(0.8); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } } @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 50% { transform: translateX(3px); } 75% { transform: translateX(-3px); } } .shake-animation { animation: shake 0.2s ease-in-out; } body.feedback-flash { background-color: #fff3e0; }
        @media (max-width: 600px) { /* ... çœç•¥ ... */ h1 { font-size: 1.6em; } .character-display { font-size: 2.5em; } #question { font-size: 1.8em; } .choice-btn { font-size: 1.1em; padding: 8px 15px; min-width: 60px; } #startBtn { font-size: 1em; padding: 10px 25px; min-width: 140px; } #battleLog { font-size: 1em; } #feedbackDisplay { font-size: 2.5em; padding: 8px 20px;} #comboDisplay { font-size: 2em; top: 55%; } #bgmToggleBtn { font-size: 1.5em; top: 10px; right: 10px; } .mode-btn, .start-method-btn { font-size: 1.2em; padding: 12px 30px; min-width: 200px; } }
    </style>
</head>
<body>
    <h1>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
    <button id="bgmToggleBtn">ğŸ”Š</button>

    <div id="modeSelectScreen">
        <h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­ï¼</h2>
        <button id="grade1ModeBtn" class="mode-btn">ğŸ’ ã—ã‚‡ã†ãŒãï¼‘ã­ã‚“ã›ã„</button>
        <button id="grade4ModeBtn" class="mode-btn">ğŸ“š ã—ã‚‡ã†ãŒãï¼”ã­ã‚“ã›ã„</button>
    </div>

    <div id="startMethodScreen" style="display: none;">
        <h2>ã©ã†ã‚„ã£ã¦ã¯ã˜ã‚ã‚‹ï¼Ÿ</h2>
        <button id="startFromBeginningBtn" class="start-method-btn">ã¯ã˜ã‚ã‹ã‚‰ (Lv 1)</button>
        <button id="continueFromLastBtn" class="start-method-btn" style="display: none;">ã¤ã¥ãã‹ã‚‰ (Lv X)</button> </div>

    <div id="battleScreen">
        <div id="enemyArea" class="character-area"> <div class="character-info"> <span class="character-name" id="enemyName"></span> <span class="character-hp-text">HP: <span id="enemyHPText"></span></span> </div> <div class="hp-bar-container"> <div class="hp-bar" id="enemyHPBar"></div> </div> <div class="character-display" id="enemyCharacter"></div> </div>
         <div id="questionArea"> <div id="question"></div> <div id="answerChoices"></div> </div>
         <div id="playerArea" class="character-area"> <div class="character-display" id="playerCharacter">ğŸ˜º</div> <div class="hp-bar-container"> <div class="hp-bar" id="playerHPBar"></div> </div> <div class="character-info"> <span class="character-name">ã«ã‚ƒã‚“ãŸã‚ã†</span> <span class="character-hp-text">HP: <span id="playerHPText"></span></span> </div> </div>
         <div id="infoArea"> <div id="battleLog"></div> <button id="startBtn"></button> </div>
    </div>
    <div id="feedbackDisplay"></div>
    <div id="comboDisplay"></div>

  <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ç­‰ ---
    let currentStage = 1; let gameMode = ''; let playerMaxHP = 15; let playerHP = playerMaxHP;
    let currentEnemy = {}; let enemyMaxHP = 10; let enemyHP = enemyMaxHP;
    let problems = []; let currentProblemIndex = 0; let questionStartTime;
    let battleInProgress = false; let comboCount = 0; let isBgmEnabled = true;
    let questionsForThisStage = 10;
    let highestClearedStage = 0; // â˜…è¿½åŠ : ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®æœ€é«˜ã‚¯ãƒªã‚¢ã‚¹ãƒ†ãƒ¼ã‚¸è¨˜éŒ²ç”¨ (èª­ã¿è¾¼ã¿æ™‚ã«è¨­å®š)

    // --- localStorage ã‚­ãƒ¼å®šç¾© ---
    const BGM_KEY = 'nekobattle_bgmEnabled_v1';
    const HIGHEST_STAGE_KEY_PREFIX = 'nekobattle_highestStage_'; // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚­ãƒ¼ã®æ¥é ­è¾

    // --- DOMè¦ç´ å–å¾— ---
    const modeSelectScreen = document.getElementById("modeSelectScreen"); const grade1ModeBtn = document.getElementById("grade1ModeBtn"); const grade4ModeBtn = document.getElementById("grade4ModeBtn");
    const startMethodScreen = document.getElementById("startMethodScreen"); // â˜…è¿½åŠ 
    const startFromBeginningBtn = document.getElementById("startFromBeginningBtn"); // â˜…è¿½åŠ 
    const continueFromLastBtn = document.getElementById("continueFromLastBtn"); // â˜…è¿½åŠ 
    const battleScreen = document.getElementById("battleScreen"); const startBtn = document.getElementById("startBtn");
    // ä»–ã®è¦ç´ å–å¾— (å¤‰æ›´ãªã—)
    const questionDiv = document.getElementById("question"); const answerChoicesDiv = document.getElementById("answerChoices"); const battleLog = document.getElementById("battleLog"); const enemyArea = document.getElementById("enemyArea"); const enemyName = document.getElementById("enemyName"); const enemyHPText = document.getElementById("enemyHPText"); const enemyHPBar = document.getElementById("enemyHPBar"); const enemyCharacter = document.getElementById("enemyCharacter"); const playerArea = document.getElementById("playerArea"); const playerHPText = document.getElementById("playerHPText"); const playerHPBar = document.getElementById("playerHPBar"); const playerCharacter = document.getElementById("playerCharacter"); const feedbackDisplay = document.getElementById("feedbackDisplay"); const comboDisplay = document.getElementById("comboDisplay"); const bgmToggleBtn = document.getElementById("bgmToggleBtn");

    // --- â˜… åŠ¹æœéŸ³ã¨BGMã®æº–å‚™ (å¤‰æ›´ãªã—) â˜… ---
    const sounds = { /* ... çœç•¥ ... */ tap: new Audio('tap.mp3'), hitEnemy: new Audio('hit_enemy.mp3'), hitPlayer: new Audio('hit_player.mp3'), wrong: new Audio('wrong.mp3'), enemyDefeated: new Audio('enemy_defeated.mp3'), criticalHit: new Audio('critical_hit.mp3'), bgmNormal: new Audio('bgm_normal.mp3'), bgmBoss: new Audio('bgm_boss.mp3') };
    sounds.bgmNormal.loop = true; sounds.bgmBoss.loop = true; sounds.bgmNormal.volume = 0.4; sounds.bgmBoss.volume = 0.35; let currentBgm = null;
    // --- â˜… ã‚µã‚¦ãƒ³ãƒ‰é–¢æ•° (å¤‰æ›´ãªã—) â˜… ---
    function playSound(soundName) { /* ... çœç•¥ ... */ } function playBgm(bgmName) { /* ... çœç•¥ ... */ } function stopBgm() { /* ... çœç•¥ ... */ } function updateBgmButton() { /* ... çœç•¥ ... */ } function loadBgmSetting() { /* ... çœç•¥ ... */ }
    bgmToggleBtn.addEventListener('click', () => { /* ... çœç•¥ ... */ isBgmEnabled = !isBgmEnabled; localStorage.setItem(BGM_KEY, JSON.stringify(isBgmEnabled)); updateBgmButton(); if (isBgmEnabled) { if (!currentBgm && battleInProgress) { playBgm(currentEnemy.type === 'boss' ? 'bgmBoss' : 'bgmNormal'); } } else { stopBgm(); } playSound('tap'); });

    const enemies = { /* ... æ•µãƒ‡ãƒ¼ã‚¿çœç•¥ ... */ 1: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 10, type: "normal" }, 2: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 13, type: "normal" }, 3: { name: "ã‚³ã‚¦ãƒ¢ãƒª", emoji: "ğŸ¦‡", hp: 16, type: "normal" }, 4: { name: "ã‚³ã‚¦ãƒ¢ãƒª", emoji: "ğŸ¦‡", hp: 20, type: "normal" }, 5: { name: "ãƒœã‚¹ ã‚´ãƒ–ãƒªãƒ³", emoji: "ğŸ‘º", hp: 30, type: "boss" }, 6: { name: "ã‚´ãƒ¼ã‚¹ãƒˆ", emoji: "ğŸ‘»", hp: 25, type: "normal" }, 7: { name: "ã‚´ãƒ¼ã‚¹ãƒˆ", emoji: "ğŸ‘»", hp: 30, type: "normal" }, 8: { name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", emoji: "ğŸ’€", hp: 35, type: "normal" }, 9: { name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", emoji: "ğŸ’€", hp: 40, type: "normal" }, 10: { name: "ãƒœã‚¹ ã‚µã‚¤ã‚¯ãƒ­ãƒ—ã‚¹", emoji: "ğŸ‘ï¸", hp: 55, type: "boss" }, 11: { name: "ã‚¾ãƒ³ãƒ“", emoji: "ğŸ§Ÿ", hp: 45, type: "normal" }, 12: { name: "ã‚¾ãƒ³ãƒ“", emoji: "ğŸ§Ÿ", hp: 50, type: "normal" }, 13: { name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹", emoji: "ğŸ‚", hp: 58, type: "normal" }, 14: { name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹", emoji: "ğŸ‚", hp: 65, type: "normal" }, 15: { name: "ãƒœã‚¹ ãƒ‰ãƒ©ã‚´ãƒ³", emoji: "ğŸ‰", hp: 85, type: "boss" } };
    const maxStage = Object.keys(enemies).length;

    // --- â˜… localStorageé–¢é€£ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° â˜… ---
    function getHighestStageKey(mode) {
        return `${HIGHEST_STAGE_KEY_PREFIX}${mode}`; // ä¾‹: 'nekobattle_highestStage_grade1'
    }
    function saveHighestStage(mode, stage) {
        const key = getHighestStageKey(mode);
        const currentHighest = loadHighestStage(mode);
        if (stage > currentHighest) { // ã‚¯ãƒªã‚¢ã—ãŸã‚¹ãƒ†ãƒ¼ã‚¸ãŒè¨˜éŒ²ã‚ˆã‚Šé«˜ã„å ´åˆã®ã¿æ›´æ–°
            localStorage.setItem(key, stage.toString());
             console.log(`Mode ${mode}: Highest stage ${stage} saved.`); // ãƒ‡ãƒãƒƒã‚°ç”¨
        }
    }
    function loadHighestStage(mode) {
        const key = getHighestStageKey(mode);
        const savedStage = localStorage.getItem(key);
        return savedStage ? parseInt(savedStage, 10) : 0; // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°0ã‚’è¿”ã™
    }

// --- å•é¡Œç”Ÿæˆé–¢æ•° ---
    function generateProblems(stage, mode, count) {
        console.log(`generateProblems called with: stage=${stage}, mode=${mode}, count=${count}`); // â˜…è¿½åŠ 
        const generatedProblems = [];
        // ... (å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾) ...
        console.log("Generated problems array:", generatedProblems); // â˜…è¿½åŠ  (é…åˆ—ã®ä¸­èº«ã‚’ç¢ºèª)
        // Fisher-Yatesã‚·ãƒ£ãƒƒãƒ•ãƒ«
        for (let i = generatedProblems.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [generatedProblems[i], generatedProblems[j]] = [generatedProblems[j], generatedProblems[i]]; }
        return generatedProblems;
    }

    // --- showQuestioné–¢æ•° ---
    function showQuestion() {
        console.log(`showQuestion called. Index: ${currentProblemIndex}, Problems array length: ${problems ? problems.length : 'undefined'}`); // â˜…è¿½åŠ 
        if (problems && problems.length > currentProblemIndex) { // â˜…è¿½åŠ : problemsé…åˆ—ãŒå­˜åœ¨ã—ã€indexãŒç¯„å›²å†…ã‹ç¢ºèª
             console.log("Current problem data:", problems[currentProblemIndex]); // â˜…è¿½åŠ 
        } else {
             console.error("Problem data is missing or index out of bounds!"); // â˜…è¿½åŠ : ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
        }

        battleInProgress = false;
        // â˜…å¤‰æ›´: çµ‚äº†æ¡ä»¶ã‚’ questionsForThisStage ã§åˆ¤å®š
        if (currentProblemIndex >= questionsForThisStage || playerHP <= 0 || enemyHP <= 0) {
            endBattle();
            return;
        }
        const p = problems[currentProblemIndex]; // ã“ã“ã§ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚‹

        // â˜…è¿½åŠ : pãŒå–å¾—ã§ããŸã‹ãƒã‚§ãƒƒã‚¯ (ã‚ˆã‚Šå®‰å…¨ã«)
        if (!p) {
            console.error("Failed to get problem data 'p' at index", currentProblemIndex);
            battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šå•é¡Œãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            // endBattle(); // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«æˆ¦é—˜ã‚’çµ‚äº†ã•ã›ã‚‹ãªã©
            return; // å‡¦ç†ä¸­æ–­
        }

        questionDiv.textContent = p.q; // pãŒå­˜åœ¨ã™ã‚Œã°å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
        questionStartTime = Date.now();
        // ... (ä»¥ä¸‹ã€å¤‰æ›´ãªã—) ...
    }    // --- handleAnsweré–¢æ•° (å¤‰æ›´ãªã—) ---
    function handleAnswer(selectedAnswer) { /* ... çœç•¥ ... */ if (battleInProgress) return; battleInProgress = true; const choiceButtons = answerChoicesDiv.querySelectorAll('.choice-btn'); choiceButtons.forEach(btn => btn.disabled = true); playSound('tap'); const elapsed = (Date.now() - questionStartTime) / 1000; const p = problems[currentProblemIndex]; let feedbackClass = ''; let damageToEnemy = 0; let damageToPlayer = 0; let logMessage = ""; let feedbackText = ""; let feedbackType = ""; let isCritical = false; let criticalTime, perfectTime, greatTime, goodTime, slowPenalty, wrongPenalty; if (gameMode === 'grade1') { criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0; slowPenalty = 1; wrongPenalty = 2; } else { criticalTime = 0.8; perfectTime = 1.5; greatTime = 2.5; goodTime = 4.0; slowPenalty = 2; wrongPenalty = 3; } if (selectedAnswer === p.a) { comboCount++; let baseDamage = 0; if (elapsed < criticalTime) { baseDamage = (gameMode === 'grade1' ? 5 : 6); logMessage = `âœ¨Critical Hit!âœ¨ (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Critical Hit!"; feedbackType = "critical"; isCritical = true; } else if (elapsed < perfectTime) { baseDamage = (gameMode === 'grade1' ? 3 : 4); logMessage = `Perfect! (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Perfect!"; feedbackType = "perfect"; } else if (elapsed < greatTime) { baseDamage = (gameMode === 'grade1' ? 2 : 2); logMessage = `Great! (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Great!"; feedbackType = "great"; } else if (elapsed < goodTime) { baseDamage = 1; logMessage = `Good (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Good"; feedbackType = "good"; } else { damageToPlayer = slowPenalty; logMessage = `Too slow... (${elapsed.toFixed(1)}ç§’) è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`; feedbackText = "Too Slow..."; feedbackType = "slow"; comboCount = 0; } let comboBonus = 0; if (comboCount >= 5) comboBonus = 2; else if (comboCount >= 3) comboBonus = 1; damageToEnemy = baseDamage + comboBonus; if(damageToEnemy > 0) { logMessage += `æ•µã«${damageToEnemy}ãƒ€ãƒ¡ãƒ¼ã‚¸!`; if (comboCount >= 3) logMessage += ` (${comboCount} Combo!)`; feedbackClass = 'feedback-flash'; shakeCharacter('enemyCharacter'); playSound('hitEnemy'); if(isCritical) playSound('criticalHit'); } else if (damageToPlayer > 0) { feedbackClass = 'feedback-damage-player'; shakeCharacter('playerCharacter'); playSound('hitPlayer'); } else { feedbackClass = 'feedback-correct'; } } else { playSound('wrong'); damageToPlayer = wrongPenalty; logMessage = `Wrong! è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`; feedbackText = "Wrong!"; feedbackType = "wrong"; feedbackClass = 'feedback-wrong'; comboCount = 0; shakeCharacter('playerCharacter'); playSound('hitPlayer'); } updateComboDisplay(); enemyHP -= damageToEnemy; playerHP -= damageToPlayer; enemyHPText.textContent = Math.max(0, enemyHP); playerHPText.textContent = Math.max(0, playerHP); updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP); battleLog.textContent = logMessage; if(feedbackText) showFeedback(feedbackText, feedbackType); if (feedbackClass) { document.body.classList.add(feedbackClass); setTimeout(() => { document.body.classList.remove(feedbackClass); }, 150); } currentProblemIndex++; setTimeout(() => { if (playerHP <= 0 || enemyHP <= 0 || currentProblemIndex >= questionsForThisStage) { endBattle(); } else { showQuestion(); } }, 1000); }

    // --- startBattleé–¢æ•° (å¤‰æ›´ãªã—) ---
    function startBattle() { /* ... çœç•¥ ... */ currentEnemy = enemies[currentStage] || enemies[maxStage]; enemyMaxHP = currentEnemy.hp; if (currentEnemy.type === 'boss') { enemyMaxHP = Math.floor(enemyMaxHP * 1.5); } if (gameMode === 'grade1') { enemyMaxHP = Math.max(5, Math.floor(enemyMaxHP * 0.7)); } enemyHP = enemyMaxHP; playerHP = playerMaxHP; currentProblemIndex = 0; comboCount = 0; updateComboDisplay(); questionsForThisStage = (currentEnemy.type === 'boss') ? 20 : 10; problems = generateProblems(currentStage, gameMode, questionsForThisStage); enemyName.textContent = `${currentEnemy.emoji} ${currentEnemy.name} (Lv${currentStage})`; enemyHPText.textContent = enemyHP; playerHPText.textContent = playerHP; updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP); enemyCharacter.textContent = currentEnemy.emoji; enemyCharacter.classList.remove('defeated'); stopBgm(); if (currentEnemy.type === 'boss') { document.body.classList.add('boss-battle-bg'); battleLog.textContent = `ğŸ”¥ãƒœã‚¹å‡ºç¾ï¼ ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼ğŸ”¥`; playBgm('bgmBoss'); } else { document.body.classList.remove('boss-battle-bg'); battleLog.textContent = `Lv${currentStage} ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`; playBgm('bgmNormal'); } startBtn.style.display = "none"; battleInProgress = false; setTimeout(showQuestion, 1500); }

    // --- endBattleé–¢æ•° (â˜…ã‚¯ãƒªã‚¢çŠ¶æ³ä¿å­˜ã‚’è¿½åŠ ) ---
    function endBattle() {
        battleInProgress = true; answerChoicesDiv.innerHTML = ""; questionDiv.textContent = "Battle End!"; comboDisplay.classList.remove('show'); stopBgm();
        let resultMessage = ""; let nextButtonText = ""; let isVictory = false;

        if (enemyHP <= 0) { // å‹åˆ©
            isVictory = true; playSound('enemyDefeated'); enemyCharacter.classList.add('defeated');
            resultMessage = `ğŸ‰å‹åˆ©ï¼ ${currentEnemy.name} ã‚’ãŸãŠã—ãŸï¼ğŸ‰`;
            if (currentEnemy.type === 'boss') { resultMessage += ` ã™ã”ã„ï¼ãƒœã‚¹ã‚’æ’ƒç ´ã—ãŸãï¼`; }

            // â˜…è¿½åŠ : ã‚¯ãƒªã‚¢çŠ¶æ³ã‚’ä¿å­˜ (ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ç•ªå·ã‚’ä¿å­˜)
            saveHighestStage(gameMode, currentStage);

            currentStage++; // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸
            if (currentStage > maxStage) { resultMessage += " ğŸ†å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼ğŸ†"; startBtn.style.display = "none"; }
            else { nextButtonText = `æ¬¡ã®æ•µ (Lv${currentStage}) ã¨æˆ¦ã†ï¼`; startBtn.style.display = "inline-block"; }
        } else { // æ•—åŒ— or å•é¡Œåˆ‡ã‚Œ
             resultMessage = playerHP <= 0 ? "ğŸ˜­æ•—åŒ—...ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼" : "æ™‚é–“åˆ‡ã‚Œ...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼";
             nextButtonText = "å†æŒ‘æˆ¦ï¼"; startBtn.style.display = "inline-block";
        }
        battleLog.textContent = resultMessage; if (nextButtonText) { startBtn.textContent = nextButtonText; }
        document.body.classList.add(isVictory ? 'feedback-correct' : 'feedback-wrong'); setTimeout(() => { document.body.classList.remove('feedback-correct', 'feedback-wrong', 'boss-battle-bg'); }, 1000);
    }

    // --- â˜… ãƒ¢ãƒ¼ãƒ‰é¸æŠå¾Œã®å‡¦ç†ã‚’å¤‰æ›´ â˜… ---
    function selectMode(selectedMode) {
        playSound('tap');
        gameMode = selectedMode; // ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
        highestClearedStage = loadHighestStage(gameMode); // æœ€é«˜ã‚¯ãƒªã‚¢ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿

        modeSelectScreen.style.display = 'none'; // ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã‚’éš ã™
        startMethodScreen.style.display = 'flex'; // ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠç”»é¢ã‚’è¡¨ç¤º

        // ã€Œã¤ã¥ãã‹ã‚‰ã€ãƒœã‚¿ãƒ³ã®è¨­å®š
        if (highestClearedStage > 0 && highestClearedStage < maxStage) {
            const nextStage = highestClearedStage + 1;
            continueFromLastBtn.textContent = `ã¤ã¥ãã‹ã‚‰ (Lv ${nextStage})`;
            continueFromLastBtn.style.display = 'inline-block'; // è¡¨ç¤º
            continueFromLastBtn.disabled = false; // æœ‰åŠ¹åŒ–
        } else {
            continueFromLastBtn.style.display = 'none'; // éè¡¨ç¤º
             continueFromLastBtn.disabled = true; // ç„¡åŠ¹åŒ– (å¿µã®ãŸã‚)
        }
         // BGMè¨­å®šèª­ã¿è¾¼ã¿ (ã“ã“ã§å‘¼ã¶ã®ãŒè‰¯ã„)
         loadBgmSetting();
    }

    // --- â˜… ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠãƒœã‚¿ãƒ³ã®å‡¦ç† â˜… ---
    function startGameFlow() {
        playSound('tap');
        startMethodScreen.style.display = 'none'; // ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•ç”»é¢ã‚’éš ã™
        battleScreen.style.display = 'flex'; // ãƒãƒˆãƒ«ç”»é¢ã‚’è¡¨ç¤º
        startBattle(); // ãƒãƒˆãƒ«é–‹å§‹ (currentStage ã¯è¨­å®šæ¸ˆã¿)
    }

    startFromBeginningBtn.addEventListener('click', () => {
        currentStage = 1; // å¿…ãšãƒ¬ãƒ™ãƒ«1ã‹ã‚‰
        startGameFlow();
    });

    continueFromLastBtn.addEventListener('click', () => {
        // highestClearedStage ã¯ selectMode ã§èª­ã¿è¾¼ã¿æ¸ˆã¿
        currentStage = highestClearedStage + 1; // æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‹ã‚‰
        // currentStageãŒmaxStageã‚’è¶…ãˆãªã„ã‚ˆã†ã«å¿µã®ãŸã‚ãƒã‚§ãƒƒã‚¯
        if (currentStage > maxStage) currentStage = maxStage;
        startGameFlow();
    });


    // --- ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    grade1ModeBtn.addEventListener("click", () => selectMode('grade1'));
    grade4ModeBtn.addEventListener("click", () => selectMode('grade4'));
    // ã€Œæ¬¡ã¸/å†æŒ‘æˆ¦ã€ãƒœã‚¿ãƒ³ (startBtn) ã®å‡¦ç†
    startBtn.addEventListener("click", () => {
        playSound('tap');
        enemyCharacter.classList.remove('defeated');
        // currentStageã¯endBattleã§æ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾startBattleã‚’å‘¼ã¶
        startBattle();
    });

    // --- åˆæœŸåŒ–å‡¦ç† ---
    loadBgmSetting(); // BGMè¨­å®šèª­ã¿è¾¼ã¿
    playerHPText.textContent = playerHP;
    updateHPBar('playerHPBar', playerHP, playerMaxHP);
    // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã€ä»–ã¯ä¸è¦

  </script>
</body>
</html>
